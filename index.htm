<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/mithril/mithril.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/keyrune@latest/css/keyrune.css" rel="stylesheet" type="text/css" />
    <link href=" https://cdn.jsdelivr.net/npm/@saeris/typeface-beleren-bold@1.0.1/index.min.css " rel="stylesheet">
    <title>MTGCollector</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <style>
      :root {
        color-scheme: light dark;

        --col-text-main: #7f8c8d;
        --col-text-sub: #34495e;
        --col-text-href: #1f8dd6;
        --col-text-strong: black;
        --col-text-alt: white;

        --col-bg-main: white;
        --col-bg-alt: #d8f2ff;
        --col-bg-footer: #111;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --col-text-main: #c3c3c3;
          --col-text-sub: #eee;
          --col-text-href: #1f8dd6;
          --col-text-strong: white;
          --col-text-alt: black;

          --col-bg-main: #09111c;
          --col-bg-alt: #03334d;
          --col-bg-footer: #eee;
        }
      }

      body {
        line-height: 1.7em;
        font-size: 13px;
        color: var(--col-text-main);
        background: var(--col-bg-main);
      }

      h1, h2, h3, h4, h5, h6, label {
        color: var(--col-text-sub);
      }

      label {
        margin-right: 0.5em;
      }

      a {
        color: var(--col-text-href);
        text-decoration: none;
      }

      a[disabled] {
        color: var(--col-text-main);
      }

      fieldset {
        border: none;
      }

      header {
        background: linear-gradient(90deg, #00d2ff 0%, #3a47d5 100%);
        z-index: 1;
        width: 100%;
        height: 25%;
        top: 0;
        left: 0;
        position: fixed !important;
      }

      header h1 {
        font-size: 3em;
        font-weight: bold;
        color: white;
        padding: 1em 1.6em;
        font-weight: 100;
        border-radius: 5px;
        line-height: 1em;
        text-align: center;
        font-family: "Beleren Bold";
        text-shadow: 0px 0px 10px black;
      }

      main {
        position: absolute;
        top: 25%;
        width: 100%;
        min-height: 12%;
        z-index: 2;
        background: var(--col-bg-main);
      }

      footer {
        background: var(--col-bg-footer);
        color: var(--col-text-alt);
        width: 100%;
        text-align: center;
      }

      #content {
        padding: 1em 1em 3em;
        max-width: 1280px;
        margin: 0 auto;
      }

      .control-group {
        display: inline-block;
        margin: 1em 3em 1em 0;
      }

      .search {
        display: flex;
        flex-direction: column;
      }

      #searchbox {
        max-width: 350px;
        height: 100px;
        margin-bottom: 0.6em;
      }

      .sets {
        display: grid;
      }

      .sets .set {
        margin: 1em;
        display: flex;
        flex-direction: row;
        background-color: var(--col-bg-alt);
        padding: 1em;
        border-radius: 15px;
      }

      .sets .info {
        display: flex;
        flex-direction: column;
      }

      .sets .info ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }

      .sets .info li {
        display: inline-block;
        margin-right: 2em;
      }

      .sets .ss {
        font-size: 350%;
        width: 68px;
        color: var(--col-text-href);
      }

      .sets a {
        font-size: 150%;
      }

      .cards {
        display: grid;
      }

      .cards .no-result {
        font-size: 120%;
        margin: 2em;
      }

      .cards .card {
        margin: 15px auto;
        display: flex;
        flex-direction: column;
        background-color: var(--col-bg-alt);
        border-radius: 15px;
      }

      .cards .card img {
        width: 250px;
        padding: 15px;
      }

      .cards .card .info {
        display: flex;
        flex-direction: column;
        padding: 0 15px 15px 15px;
        line-height: 1.3;
        width: 250px;
      }

      .cards .card .info .name {
        font-size: 110%;
      }

      .cards .card .strong {
        color: var(--col-text-strong);
      }

      .cards .card .pure-button {
        padding: initial;
        height: 1em;
        margin: 0 0.5em;
      }

      .pagination {
        margin: 1em
      }

      .pagination a {
        margin-right: 0.6em;
        display: inline-block;
      }

      .stats {
        display: flex;
        flex-wrap: wrap;
      }
      .stats ul {
        margin: 0 2em 2em 0;
      }

      @media (min-width: 48em) {
        body {
          font-size: 16px;
        }
        header h1 {
          font-size: 5em;
        }
        .sets {
          grid-template-columns: auto auto;
        }
        .cards {
          grid-template-columns: auto auto;
        }
      }

      @media (min-width: 78em) {
        .sets {
          grid-template-columns: auto auto auto;
        }
        .cards {
          grid-template-columns: auto auto auto auto;
        }
      }
    </style>
    <script>
      var model = {
        set_data: [],
        user_data: [],
        stats: {
          total_worth: 0,
          card_sum: 0,
          unique_editions: 0,
          unique_cards: 0,
          mythics: 0,
          rares: 0,
          uncommons: 0,
          commons: 0
        },
        set_sort_order: "Ascending",
        set_sort_by: "Release",
        cards_sort_by: "Name",
        cards_sort_order: "Ascending",
        filter_rarity: "All",
        items_per_page: 40,
        edit_mode: false
      }

      var user_col = {}
      var set_col = {}

      var setOrig = m.route.set;
      m.route.set = function(path, data, options) {
        setOrig(path, data, options);
        window.scrollTo(0,0);
      }

      var linkOrig = m.route.link;
      m.route.link = function(vnode) {
        linkOrig(vnode);
        window.scrollTo(0,0);
      }

      function saveUserData() {
        localStorage.setItem("user_data", Papa.unparse(model.user_data));
      }

      var indexpage = {
        view: function(vnode) {
          return [
            m("div", {style: {display: model.user_data.length == 0 ? "" : "none"}}, [
              m("h1", "Upload Manabox .csv"),
              m("input", {type: "file", id: "csv", name: "csv", accept: ".csv", onchange: function() {
                for (const file of event.target.files) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    try {
                      localStorage.setItem("user_data", reader.result);
                    } catch (e) {
                      alert("Upload failed: file likely too large")
                    }
                    reloadData();
                  };
                  reader.readAsText(file);
                }
              }}),
              m("h2", [
                m("a", {href:"#", onclick: function(e) { 
                  fetch("https://raw.githubusercontent.com/8bitmcu/mtgcollector/refs/heads/main/example.csv")
                    .then(result => result.text())
                    .then(function(text) {
                      localStorage.setItem("user_data", text);
                      reloadData();
                    })
                }}, "Try demo csv")
              ])
            ]),
            m("div", {style: {display: model.user_data.length > 0 ? "" : "none"}}, [
              m("h1", "Data"),
              m("div", {class: "stats"}, [
                m("ul", [
                  m("li", model.user_data
                            // filter out first item which is csv column names
                            .filter((item, index, arr) => arr.indexOf(item) != 0)
                            // sum all quanitity column values
                            .map(x => x[user_col.quantity])
                            .reduce((x, y) => x + y, 0) + " cards loaded"),
                  m("li", [...new Set(model.user_data.map(x => x[user_col.name]))].length + " unique cards"),
                  m("li", model.set_data
                            // filter out first item which is csv column names
                            .filter((item, index, arr) => arr.indexOf(item) != 0)
                            // filter out editions that we don't have
                            .filter(item => model.user_data.map(x => x[user_col.setcode]).indexOf(item[set_col.code]) != -1)
                            .length + " unique editions"),
                  m("li", "$" + model.user_data
                            // filter out first item which is csv column names
                            .filter((item, index, arr) => arr.indexOf(item) != 0)
                            // sum all price column values
                            .map(x => x[user_col.purchaseprice] * x[user_col.quantity])
                            .reduce((x, y) => x + y, 0)
                            .toFixed(0) + " total worth")
                ]),
                m("ul", ["mythic", "rare", "uncommon", "common"].map(rarity => m("li", model.user_data
                            // filter for rarity
                            .filter(item => item[user_col.rarity] == rarity)
                            // sum all quanitity column values
                            .map(x => x[user_col.quantity])
                            .reduce((x, y) => x + y, 0) + " " + rarity + "(s)"))
                ),
                m("ul", [
                  m("li", (JSON.stringify(localStorage).length /1024/1024).toFixed(2) + "/5MB used"),
                  m("li", [
                    m("a", {href:"#", onclick: function(e) { 
                      if (confirm("Are you sure?")) {
                        localStorage.clear();
                        reloadData();
                      }
                    }}, "Clear all Data")
                  ]),
                  m("li", [
                    m("a", {href:"#", onclick: function(e) {
                      let csv = Papa.unparse(model.user_data);
                      e.target.href = window.URL.createObjectURL(new Blob([csv], {type: "text/csv"}));
                      e.target.download = "backup_" + new Date().toLocaleDateString().replaceAll("/", "-") + ".csv";
                    }}, "Export .csv")
                  ])
                ])
              ]),
              m("h1", "Search"),
              m("div", {class: "search"}, [
                m("i", "(One search term per line, case insensitive)"),
                m("textarea", {id: "searchbox"}),
                m("span", [
                  m("button", {onclick: function(e) {m.route.set("/search/:term/page/1", {term: document.getElementById("searchbox").value})}}, "Search")
                ])
              ]),
              m("h1", [
                m(m.route.Link, {href: "/all/page/1"}, "Browse All Cards")
              ]),
              m("h1", "Browse Sets"),
              m("fieldset", [
                m("div", {class: "control-group"}, [
                  m("label", {for: "sort-by"}, "Sort By: "),
                  m("select", {id: "sort-by", onchange: function(e) {
                    model.set_sort_by = e.target.value;
                  }}, [
                    m("option", {selected: model.set_sort_by == "Release"}, "Release"),
                    m("option", {selected: model.set_sort_by == "Name"}, "Name")
                  ])
                ]),
                m("div", {class: "control-group"}, [
                  m("label", {for: "sort-order"}, "Sort Order: "),
                  m("select", {id: "sort-order", onchange: function(e) {
                    model.set_sort_order = e.target.value;
                  }}, [
                    m("option", {selected: model.set_sort_order == "Ascending"}, "Ascending"),
                    m("option", {selected: model.set_sort_order == "Descending"}, "Descending")
                  ])
                ])
              ]),
              m("div", {class : "sets"}, [
                model.set_data
                  // filter out first set which is csv column names
                  .filter((set, index, arr) => arr.indexOf(set) != 0)
                  // filter out editions that we don't have
                  .filter(set => model.user_data.map(card => card[user_col.setcode]).indexOf(set[set_col.code]) != -1)
                  // sort data
                  .sort(function(a, b) {
                    if (model.set_sort_by == "Release" && model.set_sort_order == "Ascending")
                      return new Date(a[set_col.releasedate]).getTime() - new Date(b[set_col.releasedate]).getTime();
                    if (model.set_sort_by == "Release" && model.set_sort_order == "Descending")
                      return new Date(b[set_col.releasedate]).getTime() - new Date(a[set_col.releasedate]).getTime();
                    if (model.set_sort_by == "Name" && model.set_sort_order == "Ascending")
                      return ('' + a[set_col.name]).localeCompare(b[set_col.name]);
                    if (model.set_sort_by == "Name" && model.set_sort_order == "Descending")
                      return ('' + b[set_col.name]).localeCompare(a[set_col.name]);
                  })
                  .map(function(set) {
                    return m("div", {class: "set"}, [
                      m("i", {class: "ss ss-" + set[set_col.code].toLowerCase()}),
                      m("div", {class: "info"}, [
                        m(m.route.Link, {href: "/set/" + set[set_col.code] + "/page/1"}, [
                          m("span", set[set_col.name])
                        ]),
                        m("span", set[set_col.releasedate]),
                        m("ul", [
                          m("li", model.user_data
                            .filter(card => card[user_col.setcode] == set[set_col.code])
                            .map(card => card[user_col.quantity])
                            .reduce((x, y) => x + y) + " card(s)"
                          ),
                          m("li", "$" + model.user_data
                            .filter(card => card[user_col.setcode] == set[set_col.code])
                            .filter(card => card[user_col.purchaseprice] != null)
                            .map(card => card[user_col.purchaseprice] * card[user_col.quantity])
                            .reduce((x, y) => x + y, 0)
                            .toFixed(2)
                          )
                        ])
                      ])
                    ])
                  })
                ]),
            ])
          ]}
      }

      var cardpage = {
        pagination: function(vnode, prefix, pages_len) {
          let pages = [];
          let min_page = Math.max(parseInt(vnode.attrs.page) - 10, 1);
          let max_page = Math.min(min_page + 20, pages_len);
          for(let i=min_page; i<= max_page; i++) {
            pages.push(m(m.route.Link, {href: prefix + "/page/" + i, disabled: vnode.attrs.page == i}, i));
          }

          return m("div", {class: "pagination"}, [
            m("label", "Page: "),
            m(m.route.Link, {href: "/"}, "Home"),
            min_page == 1 ? '' : m(m.route.Link, {href: prefix + "/page/1"}, "First"),
            pages_len == 0 ? '' : m(m.route.Link, {href: prefix + "/page/" + (parseInt(vnode.attrs.page)-1), disabled: vnode.attrs.page == 1}, "Previous"),
            pages,
            pages_len == 0 ? '' : m(m.route.Link, {href: prefix + "/page/" + (parseInt(vnode.attrs.page)+1), disabled: vnode.attrs.page == pages_len}, "Next"),
            max_page != pages_len ? m(m.route.Link, {href: prefix + "/page/" + pages_len}, "Last") : ''
          ]);
        },
        view: function(vnode) {
          function adjustCardCount(e) {
            let target = e.target.tagName == "I" ? e.target.parentElement : e.target;
            let isIncremental = target.getAttribute("data-direction") == "inc";
            let scryfallid = target.getAttribute("data-scryfallid");
            let item = model.user_data.filter(x => x[user_col.scryfallid] == scryfallid)[0];
            let newVal = item[user_col.quantity] + (isIncremental ? +1 : -1);

            if(newVal == 0 && confirm("Are you sure?")) {
              model.user_data.splice(model.user_data.indexOf(item), 1);
            } else {
              item[user_col.quantity] = newVal;
            }
            saveUserData();
          }
          let title = "Browsing all cards";
          let page = "/all"
          if(vnode.attrs.set) {
            title = "Browsing set: " + model.set_data.filter(x => x[set_col.code] == vnode.attrs.set)[0][set_col.name];
            page = "/set/" + vnode.attrs.set;
          }
          else if(vnode.attrs.term) {
            title = "Search Result for '" + vnode.attrs.term.replaceAll("\n", ", ") + "'"
            page = "/search/" + vnode.attrs.term;
          }

          let cards = model.user_data
            // filter out first card which is csv column names
            .filter((card, index, arr) => arr.indexOf(card) != 0)
            // rarity filter
            .filter(function(card) {
              if(model.filter_rarity == "All")
                return true;
              return card[user_col.rarity] == model.filter_rarity.toLowerCase();
            })
            .sort(function(a, b) {
              if (model.cards_sort_by == "Name" && model.cards_sort_order == "Ascending")
                return ('' + a[user_col.name]).localeCompare(b[user_col.name]);
              if (model.cards_sort_by == "Name" && model.cards_sort_order == "Descending")
                return ('' + b[user_col.name]).localeCompare(a[user_col.name]);
              if (model.cards_sort_by == "Quantity" && model.cards_sort_order == "Ascending")
                return a[user_col.quantity] - b[user_col.quantity];
              if (model.cards_sort_by == "Quantity" && model.cards_sort_order == "Descending")
                return b[user_col.quantity] - a[user_col.quantity];
              if (model.cards_sort_by == "Unit Price" && model.cards_sort_order == "Ascending")
                return a[user_col.purchaseprice] - b[user_col.purchaseprice];
              if (model.cards_sort_by == "Unit Price" && model.cards_sort_order == "Descending")
                return b[user_col.purchaseprice] - a[user_col.purchaseprice];
            })
            // filter based on which page we're on
            .filter(function(card) {
              if (vnode.attrs.set)
                return card[user_col.setcode] == vnode.attrs.set
              else if(vnode.attrs.term) {
                for(const term of vnode.attrs.term.split("\n")) {
                  if(term == '')
                    continue;
                  if(card[user_col.name].toLowerCase().indexOf(term.toLowerCase()) > -1)
                    return true;
                }
                return false;
              }
              return true;
            });

          let pages_len = Math.ceil(cards.length / model.items_per_page);

          return [
            m("h1", title),
            m("fieldset", [
              m("div", {class: "control-group"}, [
                m("label", {for: "sort-by"}, "Sort By: "),
                m("select", {id: "sort-by", onchange: function(e) {
                  model.cards_sort_by = e.target.value;
                }}, [
                  m("option", {selected: model.cards_sort_by == "Name"}, "Name"),
                  m("option", {selected: model.cards_sort_by == "Quantity"}, "Quantity"),
                  m("option", {selected: model.cards_sort_by == "Unit Price"}, "Unit Price"),
                ])
              ]),
              m("div", {class: "control-group"}, [
                m("label", {for: "sort-order"}, "Sort Order: "),
                m("select", {id: "sort-order", onchange: function(e) {
                  model.cards_sort_order = e.target.value;
                }}, [
                  m("option", {selected: model.cards_sort_order == "Ascending"}, "Ascending"),
                  m("option", {selected: model.cards_sort_order == "Descending"}, "Descending")
                ])
              ]),
              m("div", {class: "control-group"}, [
                m("label", {for: "items-per-page"}, "Rarity: "),
                m("select", {id: "items-per-page", onchange: function(e) {
                  model.filter_rarity = e.target.value;
                }}, [
                  m("option", {selected: model.filter_rarity == "All"}, "All"),
                  m("option", {selected: model.filter_rarity == "Mythic"}, "Mythic"),
                  m("option", {selected: model.filter_rarity == "Rare"}, "Rare"),
                  m("option", {selected: model.filter_rarity == "Uncommon"}, "Uncommon"),
                  m("option", {selected: model.filter_rarity == "Common"}, "Common")
                ])
              ]),
              m("div", {class: "control-group"}, [
                m("label", {for: "items-per-page"}, "Items per page: "),
                m("select", {id: "items-per-page", onchange: function(e) {
                  model.items_per_page = parseInt(e.target.value);
                }}, [
                  m("option", {selected: model.items_per_page == 40}, "40"),
                  m("option", {selected: model.items_per_page == 80}, "80"),
                  m("option", {selected: model.items_per_page == 120}, "120")
                ])
              ]),
              m("div", {class: "control-group"}, [
                m("label", {for: "edit-mode"}, "Edit Mode: "),
                m("input", {type: "checkbox", id: "edit-mode", onchange: function(e) {
                  model.edit_mode = e.target.checked;
                }})
              ])
            ]),
            this.pagination(vnode, page, pages_len),
            m("div", {class: "cards"}, [
              cards
                // pagination
                .filter(function(card, index, arr) {
                  return arr.indexOf(card) < vnode.attrs.page * model.items_per_page &&
                         arr.indexOf(card) >= (vnode.attrs.page-1) * model.items_per_page;
                })
                .map(function(card) {
                  let scryfallid = card[user_col.scryfallid];
                  let img = "https://cards.scryfall.io/normal/front/" + scryfallid[0] + "/" + scryfallid[1] + "/" + scryfallid + ".jpg";

                  return m("div", {class: "card"}, [
                    m("img", {src: img}),
                    m("div", {class: "info"}, [
                      m("span", {class: "name strong"}, card[user_col.name]),
                      m("span", "Unit Price: ", [
                        m("span", {class: "strong"}, card[user_col.purchaseprice] == null ? 'N/A' : '$' + card[user_col.purchaseprice].toFixed(2))
                      ]),
                      m("span", "Quantity: ", [
                        !model.edit_mode ? '' : m("button", {class: "pure-button", onclick: adjustCardCount, "data-scryfallid": scryfallid, "data-direction": "dec"}, [
                          m("i", {class: "ph ph-minus"})
                        ]),
                        m("span", {class: "strong"}, card[user_col.quantity]),
                        !model.edit_mode ? '' : m("button", {class: "pure-button", onclick: adjustCardCount, "data-scryfallid": scryfallid, "data-direction": "inc"}, [
                          m("i", {class: "ph ph-plus"})
                        ])
                      ])
                    ])
                  ]);
                }),
              cards.length > 0 ? '' : m("span", {class: "no-result"}, "No results found!")
            ]),
            this.pagination(vnode, page, pages_len),
          ]
        }
      }

      function reloadData() {
        Papa.parse("https://mtgjson.com/api/v5/csv/sets.csv", {
          download: true,
          complete: function(results) {
            model.set_data = results.data;

            set_col.basesetsize = model.set_data[0].indexOf("baseSetSize");
            set_col.block = model.set_data[0].indexOf("block");
            set_col.cardspheresetid = model.set_data[0].indexOf("cardsphereSetId");
            set_col.code = model.set_data[0].indexOf("code");
            set_col.isfoilonly = model.set_data[0].indexOf("isFoilOnly");
            set_col.isnonfoilonly = model.set_data[0].indexOf("isNonFoilOnly");
            set_col.isonlineonly = model.set_data[0].indexOf("isOnlineOnly");
            set_col.ispartialpreview = model.set_data[0].indexOf("isPartialPreview");
            set_col.keyrunecode = model.set_data[0].indexOf("keyruneCode");
            set_col.languages = model.set_data[0].indexOf("languages");
            set_col.mcmid = model.set_data[0].indexOf("mcmId");
            set_col.mcmidextras = model.set_data[0].indexOf("mcmIdExtras");
            set_col.mcmname = model.set_data[0].indexOf("mcmName");
            set_col.mtgocode = model.set_data[0].indexOf("mtgoCode");
            set_col.name = model.set_data[0].indexOf("name");
            set_col.parentcode = model.set_data[0].indexOf("parentCode");
            set_col.releasedate = model.set_data[0].indexOf("releaseDate");
            set_col.tcgplayergroupid = model.set_data[0].indexOf("tcgplayerGroupId");

            let ud = localStorage.getItem("user_data");
            if (ud == null)
              ud = "";
            Papa.parse(ud, {
              dynamicTyping: true,
              complete: function(results) {
                model.user_data = results.data;

                user_col.name = model.user_data[0].indexOf("Name");
                user_col.setcode = model.user_data[0].indexOf("Set code");
                user_col.setname = model.user_data[0].indexOf("Set name");
                user_col.collector = model.user_data[0].indexOf("Collector number");
                user_col.foil = model.user_data[0].indexOf("Foil");
                user_col.rarity = model.user_data[0].indexOf("Rarity");
                user_col.quantity = model.user_data[0].indexOf("Quantity");
                user_col.manaboxid = model.user_data[0].indexOf("ManaBox ID");
                user_col.scryfallid = model.user_data[0].indexOf("Scryfall ID");
                user_col.purchaseprice = model.user_data[0].indexOf("Purchase price");
                user_col.misprint = model.user_data[0].indexOf("Misprint");
                user_col.altered = model.user_data[0].indexOf("Altered");
                user_col.condition = model.user_data[0].indexOf("Condition");
                user_col.language = model.user_data[0].indexOf("Language");
                user_col.purchasecur = model.user_data[0].indexOf("Purchase price currency");

                m.route(document.getElementById("content"), "/", {
                  "/": indexpage,
                  "/all/page/:page": cardpage,
                  "/set/:set/page/:page": cardpage,
                  "/search/:term/page/:page": cardpage
                });
              }
            });
          }
        });
      }

      document.addEventListener("DOMContentLoaded", reloadData);
    </script>
  </head>
  <body>
    <header>
      <h1>MTGCollector</h1>
    </header>
    <main>
      <div id="content">
      </div>
      <footer> (C) 2025 8bitmcu</footer>
    </main>
  </body>
</html>
